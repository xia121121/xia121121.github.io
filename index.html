<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
    content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>Johnson Fitness</title>
</head>

<!-- 
  style样式主要分为三种 内联样式、内部样式、外部样式 ，这里使用的是内联样式
  样式css主要对html进行美化，css的机制主要通过过滤器来实现对指定的对象对html进行美化 
  主要的格式为：选择器{样式声明;样式声明…}
  以下使用到几种选择器 元素选择器、类选择器、ID选择器
-->
<style>
  /* 元素选择器 设置主体的样式 不同的选择器修饰相同的属性时候 外部设置影响不到局部设置，eg body的字体没法对.bigTitle类中字体产生影响*/
  body {
    background-color: #f7f4ed;
    /* body 中背景颜色 */
    color: #132c33;
    /* body 中指定文本颜色 */
    height: 100%;
    /* body 占据的高 */
    width: 100%;
    /* body 占据的宽 */
    padding: 0;
    /* body 占据的内边距0 */
    margin: 0;
    /* body 占据的外边距0 */
    border: 0;
    /* body 占据的边框0 */
    font-size: 16px;
    /* body 中的字体 */
  }

  /* 类选择器 对html中 divborder类进行美化样式 */
  .divborder {
    width: 100%;
    height: 100%;
    background-color: #f7f4ed;
    text-align: center;
    /* divborder 类中字体居中 */
    position: relative;
    /* divborder 类的定位方式relative 相对定位 */
    padding: 30px 0;
    /* divborder 类上下边距30px 左右0px */
  }

  .titleName {
    font-weight: 700;
    margin-bottom: 20px;
  }

  .bigTitle {
    font-size: 25px;
  }

  .smallTitle {
    font-size: 20px;
  }

  table {
    width: 300px;
    margin: 20px auto;
    /* table 元素上下边距20px 左右自适应 */
  }

  /* table 元素 tr元素定义表格行，th元素定义表头，td元素定义表格单元格。*/
  table tr {
    margin: 10px 0;
  }

  button {
    width: 100%;
    height: 45px;
    border: none;
    border-radius: 10px;
    /* button 的边框圆角 */
    padding: 0;
    font-size: 16px;
    font-weight: 700;
  }

  /*伪类选择器  :link 未访问的链接
              :visited 已访问的链接
              :hover 鼠标悬浮到连接上，即移动在连接上
              :active 选定的链接，被激活 
  */
  /* 边框样式值 none:默认无边框
              dotted:定义一个点线框
              dashed:定义一个虚线框
              solid :定义实现边界
              double:定义两个边界。两个边界的宽度和border-width的值相同
              groove:定义3D沟槽边界。效果取决于边界的颜色值
              ridge :定义3D 脊边界。效果取决于边界的颜色值
              inset :定义一个3D的嵌入边框。效果取决于边界的颜色值
              outset:定义一个3D突出边框。效果取决于边界的颜色值
              hidden:隐藏边框 
  */
  button:active {
    border: 0.0625rem solid #f7f4ed;
    /* button  宽0.0625rem 实线边框 颜色 #f7f4ed*/
  }

  /* ID选择器 */
  #upload {
    color: #f7f4ed;
    border-radius: 99px;
    background-color: #2c9678;
  }

  #Stop {
    color: #f7f4ed;
    border-radius: 99px;
    background-color: #ed5126;
  }

  #fileTd {
    width: 200px;
    height: 80px;
    position: relative;
  }

  #newfile {
    position: absolute;
    z-index: 1;
    /* newfile中元素的堆叠顺序1 0在最前位置*/
    opacity: 0;
    /* newfile中不透明属性为0 0表示对象是完全透明的。*/
    height: 45px;
    border-radius: 99px;
  }

  #fileButton {
    z-index: 0;
    color: #f7f4ed;
    border-radius: 99px;
    background-color: #5779c3;
  }

  #prgp {
    margin: 10px 0;
    border: 0;
    border: 2px solid #2c9678;
    border-radius: 20px;
    width: 300px;
    height: 20px;
  }

  #prgp::-webkit-progress-bar {
    background: #f7f4ed;
    border-radius: 10px;
  }

  #prgp::-webkit-progress-value {
    background: #2c9678;
  }

  /* 设置自适应屏幕 */
  @media all and (min-width: 700px) {
    body {
      background-color: #21242d;
      color: #132c33;
    }

    .divborder {
      position: absolute;
      left: 50%;
      top: 10%;
      left: 50%;
      width: 500px;
      height: 500px;
      transform: translateX(-50%);
      border-radius: 5%;
      border: 2px solid #f7f4ed;
      text-align: center;
      padding: 50px 0;
    }

    .titleName {
      display: flex;
      justify-content: center;
      word-spacing: 4px;
    }

    .bigTitle {
      font-size: 22px;
      margin-right: 8px;
    }

    .smallTitle {
      font-size: 22px;
    }

    table {
      width: 350px;
    }

    #prgp {
      width: 350px;
    }
  }
</style>

<body>
  <div class="divborder">
    <div class="titleName">
      <div class="bigTitle">Johnson Fitness</div>
      <div class="smallTitle"> Console Firmware update</div>
    </div>
    <hr />

    <div style="margin-top: 10px;">
      <span>Running partition:</span><br />
      <span id="Running" style="color: #2c9678"></span>
    </div>

    <table class="fileWrap">
      <tr>
        <td id="fileTd" colspan="3">
          <input id="newfile" type="file" accept=".bin" style="width: 100%" onchange="setpath()" />
          <!-- accept=".bin" 接受的文件类型为bin文件，不支持其它类型文件-->
          <label for="newfile">
            <button id="fileButton" type="button">Choose a firmware</button>
          </label>
        </td>
      </tr>
      <tr>
        <td colspan="2" style="width: 200px">
          <button id="upload" type="button" onclick="upload()">Upload</button>
        </td>
        <td style="width: 100px">
          <button id="Stop" type="button" onclick="StopUpload()">Stop</button>
        </td>
      </tr>
    </table>
    <progress id="prgp" value="0" max="100"></progress>
    <div id="prg">progress: 0%</div>
    <div id="time">0k/s</div>
    <hr />
    <div style="margin-top: 10px;">
      <span>Response message:</span>
      <br />
      <span id="message"></span>
    </div>
  </div>
</body>
<script>
  // 获取URL参数中的设备IP和端口
  function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
  }

  // 获取设备IP和端口
  const deviceIp = getUrlParameter('device_ip') || '192.168.4.1';  // 默认AP IP
  const devicePort = getUrlParameter('device_port') || '88';
  const deviceBaseUrl = `http://${deviceIp}:${devicePort}`;

  var Running = document.getElementById("Running"); //访问 HTML 元素
  //页面加载完毕后立刻执行的操作
  window.onload = function () {
    fetch(`${deviceBaseUrl}/Now`).then((response) => {    //基本的fetch请求 http请求
      if (response.status == 200) {       //获取http请求状态 200 请求成功
        response.json().then(function (data) {  //json数据
          Running.innerHTML =
            "Type: " +
            data.OTAsubtype +             //解析json数据
            "<br>Offset: 0x" +
            data.address.toString(16) +   //解析json数据转换成字符串
            "<br>Ver: " +
            data.version +                //解析json数据
            "<br>Time: " +
            data.date +                   //解析json数据
            " " +
            data.time;                    //解析json数据
        });
      } else {                            //http请求失败
        Running.innerHTML = "status: " + response.status;
      }
    });
  };
  //选择文件
  function setpath() {
    var default_path = document.getElementById("newfile").files[0].name;//获取文件名
    document.getElementById("fileButton").innerHTML = default_path;     //显示选中的文件名
  }

  var xhr;
  var ot;
  var oloaded;
  //上传文件方法
  function upload() {
    var fileInput = document.getElementById("newfile").files; // 获取文件对象
    var message = document.getElementById("message");         // 要设置的消息
    message.innerHTML = "";                                   // 初始化显示消息
    if (fileInput.length <= 0) {                              // 文件长度小于的等于0的时候
      message.innerHTML = "Unselected file!";                 // 没有选择文件
      message.style.color = "#ED5126";                        // 设置样式字体颜色
    } else if (fileInput[0].size > 3584 * 1024) {             // 文件超过最大限制的时候
      message.innerHTML = "The file size must be less than 1000KB!"; // 提示超过限制
      message.style.color = "#ED5126";                        // 设置样式字体颜色
    } else {
      var fileObj = fileInput[0];                             // js 获取文件对象
      xhr = new XMLHttpRequest();                             // XMLHttpRequest 对象
      xhr.open("post", `${deviceBaseUrl}/upload`, true);                      // post方式，/upload 为请求url，true 该参数规定请求是否异步处理。
      xhr.onload = uploadComplete;                            // 请求完成
      xhr.onerror = uploadFailed;                             // 请求失败
      xhr.upload.onprogress = progressFunction;               //【上传进度调用方法实现】
      xhr.upload.onloadstart = function () {                  // 开始上传的时候执行方法
        ot = new Date().getTime();                            // 设置上传开始时间
        oloaded = 0;                                          // 设置上传开始时，以上传的文件大小为0
      };
      xhr.send(fileObj);                                      // 开始上传，发送form数据
    }
  }
  //上传进度实现方法，上传过程中会频繁调用该方法
  function progressFunction(evt) {
    var progressBar = document.getElementById("prgp");        // 获取progressBar 进度条对象
    var percentageDiv = document.getElementById("prg");       // 进度显示
    if (evt.lengthComputable) {                               // event.lengthComputable不为真，则event.total等于0
      progressBar.max = evt.total;                            // event.total是需要传输的总字节
      progressBar.value = evt.loaded;                         // event.loaded是已经传输的字节
      percentageDiv.innerHTML = "progress: " + Math.round((evt.loaded / evt.total) * 100) + "%"; // Math.round 四舍五入
    }

    var time = document.getElementById("time");               // 获取time对象
    var nt = new Date().getTime();                            // 获取当前时间
    var pertime = (nt - ot) / 1000;                           // 计算出上次调用该方法时到现在的时间差，单位为s
    ot = new Date().getTime();                                // 重新赋值时间，用于下次计算

    var perload = evt.loaded - oloaded;                       // 计算该分段上传的文件大小，单位b
    oloaded = evt.loaded;                                     // 重新赋值已上传文件大小，用以下次计算

    //上传速度计算
    var speed = perload / pertime;  //单位b/s
    var bspeed = speed;
    var units = "b/s";              //单位名称
    if (speed / 1024 > 1) {
      speed = speed / 1024;
      units = "k/s";
    }
    if (speed / 1024 > 1) {
      speed = speed / 1024;
      units = "M/s";
    }
    speed = speed.toFixed(1);       //toFixed 四舍五入为指定小数位数的数字 eg: number = 13.37  number.toFixed(1) = 13.4
    var resttime = ((evt.total - evt.loaded) / bspeed).toFixed(1);                      // 剩余时间
    time.innerHTML = "Speed: " + speed + units + ", Remaining time: " + resttime + "s"; // 显示时间速度
    if (bspeed == 0)
      time.innerHTML = "Upload cancelled!";
    message.style.color = "#ED5126";
  }
  //上传成功响应
  function uploadComplete(x) {
    //服务断接收完文件返回的结果
    if (xhr.status == 200) {                //post请求成功
      var counter = 0;
      Running.innerHTML = "";               //初始化显示区
      message.innerHTML = "File uploaded successfully<br>" + xhr.responseText + "<br>Waiting for the device to restart<br>waiting"; //显示请求成功 <br> 换行
      message.style.color = "#2C9678";      //设置颜色
      timer = setInterval(function () {             //定时函数，页面会每隔1000毫秒正常执行一次 1S请求一次 Now
        fetch(`${deviceBaseUrl}/Now`).then((response) => {
          if (response.status == 200) {     //请求成功
            location.assign(location.href); //获取或者设置整个URL 跳转网页 重定向页面
            //location.replace();
          }
        });
        if (counter >= 50) {
          clearInterval(timer);
        } else {
          message.innerHTML = message.innerHTML + " ."; //定时器回调显示 ........
        }
        counter = counter + 1;
      }, 1000);
    } else {                            //上传失败
      var errorMess = "status: " + xhr.status + "<br>responseText: " + xhr.responseText; //获取错误的请求
      message.innerHTML = errorMess;    //显示错误内容
      message.style.color = "#ED5126";  //设置颜色
    }
  }
  //上传失败响应
  function uploadFailed(x) {
    message.innerHTML = "Upload error!";
    message.style.color = "#ED5126";
  }
  //终止上传
  function StopUpload() {
    xhr.abort();
    message.innerHTML = "Upload terminated!";
    message.style.color = "#ED5126";
  }
</script>

</html>
