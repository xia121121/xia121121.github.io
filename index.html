// 获取URL参数中的设备IP和端口
function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// 获取设备IP和端口
const deviceIp = getUrlParameter('device_ip') || '10.10.10.1';
const devicePort = getUrlParameter('device_port') || '88';

// 重要：构建完整的HTTP URL，但添加错误处理
function getDeviceUrl(path) {
    return `http://${deviceIp}:${devicePort}${path}`;
}

var Running = document.getElementById("Running");

//页面加载完毕后立刻执行的操作
window.onload = function () {
    console.log("Device IP:", deviceIp, "Port:", devicePort);
    console.log("Full URL:", getDeviceUrl('/Now'));
    
    // 使用完整的HTTP URL
    fetch(getDeviceUrl('/Now'))
        .then((response) => {
            console.log("fetch/Now - Status:", response.status);
            if (response.status == 200) {
                return response.json().then(function (data) {
                    console.log("response.json", data);
                    Running.innerHTML =
                        "Type: " +
                        data.OTAsubtype +
                        "<br>Offset: 0x" +
                        data.address.toString(16) +
                        "<br>Ver: " +
                        data.version +
                        "<br>Time: " +
                        data.date + " " + data.time;
                });
            } else {
                Running.innerHTML = "status: " + response.status;
                console.log("HTTP Error:", response.status);
                throw new Error(`HTTP ${response.status}`);
            }
        })
        .catch(error => {
            console.error("Fetch error:", error);
            Running.innerHTML = "Connection failed: " + error.message;
            
            // 显示连接帮助信息
            const message = document.getElementById("message");
            message.innerHTML = `
                <div style="color: #ED5126;">
                    <strong>连接失败！请检查：</strong><br>
                    1. 手机是否连接到ESP32的WiFi热点<br>
                    2. ESP32 IP地址是否正确 (${deviceIp}:${devicePort})<br>
                    3. ESP32是否正在运行Web服务器<br>
                    4. 尝试使用本地测试（见下方说明）
                </div>
            `;
        });
};

//选择文件
function setpath() {
    var default_path = document.getElementById("newfile").files[0].name;
    document.getElementById("fileButton").innerHTML = default_path;
}

var xhr;
var ot;
var oloaded;

//上传文件方法
function upload() {
    var fileInput = document.getElementById("newfile").files;
    var message = document.getElementById("message");
    message.innerHTML = "";
    
    if (fileInput.length <= 0) {
        message.innerHTML = "Unselected file!";
        message.style.color = "#ED5126";
        return;
    }
    
    if (fileInput[0].size > 3584 * 1024) {
        message.innerHTML = "The file size must be less than 1000KB!";
        message.style.color = "#ED5126";
        return;
    }
    
    var fileObj = fileInput[0];
    xhr = new XMLHttpRequest();
    
    // 使用完整的HTTP URL
    xhr.open("POST", getDeviceUrl('/upload'), true);
    xhr.onload = uploadComplete;
    xhr.onerror = uploadFailed;
    xhr.upload.onprogress = progressFunction;
    xhr.upload.onloadstart = function () {
        ot = new Date().getTime();
        oloaded = 0;
    };
    
    message.innerHTML = "开始上传...";
    message.style.color = "#2C9678";
    xhr.send(fileObj);
}

//上传进度实现方法
function progressFunction(evt) {
    var progressBar = document.getElementById("prgp");
    var percentageDiv = document.getElementById("prg");
    
    if (evt.lengthComputable) {
        progressBar.max = evt.total;
        progressBar.value = evt.loaded;
        percentageDiv.innerHTML = "progress: " + Math.round((evt.loaded / evt.total) * 100) + "%";
    }

    var time = document.getElementById("time");
    var nt = new Date().getTime();
    var pertime = (nt - ot) / 1000;
    ot = new Date().getTime();

    var perload = evt.loaded - oloaded;
    oloaded = evt.loaded;

    var speed = perload / pertime;
    var bspeed = speed;
    var units = "b/s";
    
    if (speed / 1024 > 1) {
        speed = speed / 1024;
        units = "k/s";
    }
    if (speed / 1024 > 1) {
        speed = speed / 1024;
        units = "M/s";
    }
    
    speed = speed.toFixed(1);
    var resttime = ((evt.total - evt.loaded) / bspeed).toFixed(1);
    time.innerHTML = "Speed: " + speed + units + ", Remaining time: " + resttime + "s";
    
    if (bspeed == 0) {
        time.innerHTML = "Upload cancelled!";
        message.style.color = "#ED5126";
    }
}

//上传成功响应
function uploadComplete() {
    if (xhr.status == 200) {
        var counter = 0;
        Running.innerHTML = "";
        message.innerHTML = "File uploaded successfully<br>" + xhr.responseText + "<br>Waiting for the device to restart<br>waiting";
        message.style.color = "#2C9678";
        
        var timer = setInterval(function () {
            fetch(getDeviceUrl('/Now')).then((response) => {
                if (response.status == 200) {
                    clearInterval(timer);
                    location.reload();
                }
            }).catch(error => {
                console.error("Status check failed:", error);
            });
            
            if (counter >= 50) {
                clearInterval(timer);
                message.innerHTML += "<br>Timeout: Device may have restarted";
            } else {
                message.innerHTML = message.innerHTML + " .";
            }
            counter = counter + 1;
        }, 1000);
    } else {
        var errorMess = "status: " + xhr.status + "<br>responseText: " + xhr.responseText;
        message.innerHTML = errorMess;
        message.style.color = "#ED5126";
    }
}

//上传失败响应
function uploadFailed() {
    message.innerHTML = "Upload error! Check device connection.";
    message.style.color = "#ED5126";
}

//终止上传
function StopUpload() {
    if (xhr) {
        xhr.abort();
        message.innerHTML = "Upload terminated!";
        message.style.color = "#ED5126";
    }
}
